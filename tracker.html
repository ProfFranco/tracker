<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    .tracker-wrapper {
        font-family: 'Roboto', sans-serif;
        display: block;
        width: 100%;
        /* L'h√©bergement dans un iframe g√®re l'isolation, on simplifie le reset */
    }

    .tracker-wrapper * {
        --card-bg: #2d3436;
        --main-color: #00cec9;
        --text-color: #dfe6e9;
        --disabled-color: #636e72;
        --error-color: #ff4757;
        box-sizing: border-box;
        font-family: inherit;
        margin: 0;
        padding: 0;
        line-height: 1.5;
    }

    .correction-card {
        background-color: var(--card-bg);
        color: var(--text-color);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        max-width: 800px;
        margin: 15px auto;
    }

    .correction-card h2 {
        font-family: 'Orbitron', sans-serif;
        color: #fff;
        text-align: center;
        margin-bottom: 25px;
        text-shadow: 0 0 5px var(--main-color), 0 0 10px var(--main-color), 0 0 20px rgba(0, 206, 201, 0.7);
        font-size: 1.8em;
        letter-spacing: 3px;
        font-weight: 700;
    }

    .correction-card hr {
        border: none;
        border-top: 1px solid var(--disabled-color);
        margin: 15px 0;
    }

    .header-indicators {
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        gap: 15px;
        padding: 10px 0 20px 0;
    }

    @media (max-width: 600px) {
        .header-indicators {
            flex-direction: column;
            align-items: center;
        }

        .stat-box,
        .mood-box {
            width: 90%;
            max-width: 350px;
        }
    }

    .stat-box {
        text-align: center;
        padding: 10px;
        border: 1px solid var(--disabled-color);
        border-radius: 8px;
        min-width: 150px;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.02);
        flex-grow: 1;
    }

    .stat-box p {
        margin: 0;
        font-size: 1.1em;
        color: #fff;
        line-height: 1.2;
        text-shadow: 0 0 8px rgba(0, 206, 201, 0.6);
    }

    .stat-value {
        font-size: 2.2em;
        font-weight: bold;
        color: #fff;
        display: inline;
        margin-top: 5px;
    }

    .mood-box {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 15px;
        border: 1px solid var(--disabled-color);
        border-radius: 8px;
        min-width: 150px;
        background-color: #3b4347;
        transition: background-color 0.5s ease;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        min-height: 100px;
        flex-grow: 1;
    }

    .mood-icon-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
    }

    #current-mood-icon {
        font-size: 2.5em;
        line-height: 1;
        margin-bottom: 5px;
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
    }

    #current-mood-text {
        font-weight: bold;
        font-size: 0.9em;
        margin: 0;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .mood-label {
        margin: 5px 0 0;
        font-size: 1.1em;
        color: #fff;
        font-weight: normal;
        text-shadow: 0 0 8px rgba(0, 206, 201, 0.6);
    }

    .timeline-container {
        position: relative;
        padding: 20px 0 30px;
    }

    .timeline-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        z-index: 2;
    }

    .step-title {
        font-size: 0.8em;
        padding: 0 5px;
    }

    @media (max-width: 600px) {
        .step-title {
            font-size: 0.7em;
        }
    }

    .timeline-item {
        width: 17%;
        text-align: center;
        opacity: 1;
        transition: opacity 0.5s ease;
    }

    .step-icon {
        font-size: 1.2em;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 10px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--card-bg);
        border: 4px solid var(--disabled-color);
        color: var(--disabled-color);
        z-index: 5;
        position: relative;
        transition: all 0.3s ease;
    }

    .timeline-item.completed .step-icon {
        border-color: var(--main-color);
        color: var(--main-color);
    }

    .timeline-item.active .step-icon {
        border-color: var(--main-color);
        color: var(--main-color);
        box-shadow: 0 0 15px rgba(0, 206, 201, 0.9);
        transform: scale(1.1);
    }

    .step-arrow {
        font-size: 1.5em;
        color: var(--disabled-color);
        flex-grow: 1;
        text-align: center;
        margin: 0 5px;
        transition: color 0.5s ease, transform 0.5s ease;
    }

    .step-arrow.completed {
        color: var(--main-color);
        transform: scale(1.2);
    }

    .return-date-info {
        border: 2px solid var(--main-color);
        border-radius: 10px;
        background-color: rgba(0, 206, 201, 0.05);
        text-align: center;
        font-size: 1.3em;
        font-weight: bold;
        color: var(--text-color);
        padding: 15px 10px;
        margin-top: 20px;
        box-shadow: 0 0 10px rgba(0, 206, 201, 0.1);
    }

    .return-date-value {
        color: var(--main-color);
        margin-left: 5px;
        text-shadow: 0 0 5px rgba(0, 206, 201, 0.5);
    }

    .quote-text {
        text-align: center;
        font-style: italic;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 20px;
        margin-bottom: 10px;
        padding: 0 20px;
        font-size: 1em;
        line-height: 1.4;
    }

    .button-group {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-top: 15px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
        text-align: center;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
    }

    .report-btn {
        background-color: var(--main-color);
        color: var(--card-bg);
        flex-grow: 1;
    }

    .report-btn:not([disabled]) {
        background-color: var(--main-color);
        color: #1a1a1a;
        font-size: 1.05em;
        box-shadow: 0 0 10px var(--main-color), 0 0 20px rgba(0, 206, 201, 0.5);
    }

    .report-btn:hover:not([disabled]) {
        background-color: #00b894;
        transform: translateY(-2px);
        box-shadow: 0 0 15px #00b894, 0 5px 10px rgba(0, 0, 0, 0.5);
    }

    .report-btn[disabled] {
        background-color: var(--disabled-color);
        cursor: not-allowed;
        color: #fff;
        box-shadow: none;
    }

    .remarks-btn {
        background-color: transparent;
        border: 2px solid var(--main-color);
        color: var(--main-color);
        flex-grow: 1;
    }

    .remarks-btn:hover:not(.hidden) {
        background-color: var(--main-color);
        color: var(--card-bg);
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
    }

    .hidden {
        display: none !important;
    }

    .remarks-area {
        margin-top: 15px;
        padding: 15px;
        background-color: #3b4347;
        border-radius: 8px;
        font-size: 0.9em;
    }

    .remarks-area.important-bg {
        background-color: rgba(0, 206, 201, 0.1);
        border: 2px solid var(--main-color);
    }

    .remarks-area.error {
        border: 2px solid var(--error-color);
        background-color: rgba(255, 71, 87, 0.15);
    }

    .remarks-area.error .remarks-list li {
        color: var(--error-color);
        border-left-color: var(--error-color);
    }

    .remarks-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    .remarks-list li {
        margin-bottom: 8px;
        padding-left: 10px;
        border-left: 3px solid var(--main-color);
        color: var(--text-color);
        line-height: 1.3;
    }

    .remarks-list li strong {
        color: #fff;
    }

    .remarks-list li.important {
        border-left-color: var(--error-color);
        color: var(--error-color);
        font-weight: bold;
    }
</style>

<div class="tracker-wrapper">
    <div class="correction-card">
        <h2>DS n¬∞<span id="ds-number">[X]</span> - Suivi de Correction</h2>

        <div class="header-indicators">
            <div class="stat-box average-gauge">
                <p>Moyenne de Classe</p>
                <span id="current-average" class="stat-value">--</span>
            </div>

            <div id="mood-box" class="mood-box">
                <div class="mood-icon-container">
                    <span id="current-mood-icon">...</span>
                    <p id="current-mood-text">...</p>
                </div>
                <p class="mood-label">Humeur du correcteur</p>
            </div>

            <div class="stat-box copies-gauge">
                <p>Copies Corrig√©es</p>
                <span id="corrected-count" class="stat-value">--</span>
                <span id="total-count">/--</span>
            </div>
        </div>
        
        <div class="timeline-container">
            <div id="timeline-steps" class="timeline-steps"></div>

            <div class="return-date-info">
                Date estim√©e de retour des copies :
                <span id="estimated-return-date" class="return-date-value">--/--/--</span>
            </div>

            <div id="quote-display" class="quote-text"></div>

            <div id="remarks-area" class="remarks-area hidden"></div>

            <div class="button-group">
                <button id="remarks-button" class="btn remarks-btn hidden">
                    üì¢ Afficher les remarques sur le DS
                </button>
                <button id="report-button" class="btn report-btn" disabled="">
                    T√©l√©charger le rapport
                </button>
            </div>
        </div>

        <script>
            // =================================================================
            // ‚ö†Ô∏è 1. CONFIGURATION
            // =================================================================
            // Remplacez ces valeurs par les v√¥tres.
            const SHEET_ID = '1pKcYxUJtMthkJ9mN96LP4RzwTMoitBGs1b-1rw2aAMg';
            const GID_STATUT = '1069440488';
            const GID_REMARQUES = '143784605';

            const DEFAULT_SHEET_ID = 'VOTRE_ID_DE_FEUILLE_ICI';

            const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_STATUT}`;
            const REMARKS_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_REMARQUES}`;

            // =================================================================
            // 2. CONSTANTES
            // =================================================================

            const CORRECTION_STEPS = [
                { title: "R√©daction du corrig√©", icon: "üìù" },
                { title: "√âlaboration du bar√®me", icon: "‚öñÔ∏è" },
                { title: "Correction des copies test", icon: "üîç" },
                { title: "Correction des copies", icon: "üñçÔ∏è" },
                { title: "Normalisation des notes", icon: "üìä" },
                { title: "Termin√©", icon: "‚úÖ" }
            ];

            const MOODS = {
                "Motiv√©": { icon: "üòÄ", hue: 150 },
                "Concentr√©": { icon: "üß†", hue: 120 },
                "Perplexe": { icon: "ü§î", hue: 60 },
                "Enthousiaste": { icon: "ü•≥", hue: 90 },
                "√âpuis√©": { icon: "üò¥", hue: 30 },
                "√ânerv√©": { icon: "üò°", hue: 0 },
                "D√©sesp√©r√©": { icon: "üò©", hue: 0 }
            };

            const DEFAULT_LOADING_STATE = { currentMood: "Concentr√©", hue: 120 };

            // =================================================================
            // 3. FONCTIONS DE R√âCUP√âRATION DES DONN√âES
            // =================================================================

            async function fetchCurrentState() {
                try {
                    if (SHEET_ID === DEFAULT_SHEET_ID) {
                        throw new Error("Erreur de configuration: Veuillez remplacer l'ID de la feuille.");
                    }

                    const cacheBuster = `&v=${new Date().getTime()}`;
                    const url = GOOGLE_SHEET_URL + cacheBuster;
                    const response = await fetch(url);

                    if (!response.ok) {
                        const errorDetails = response.status === 404 ? "Code 404 (Non trouv√©). Assurez-vous que la feuille est 'Publi√©e sur le Web' en format CSV." : `Code ${response.status}. Acc√®s refus√©.`;
                        throw new Error(`Erreur HTTP: ${errorDetails}`);
                    }

                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');
                    const state = {};

                    lines.forEach(line => {
                        const parts = line.split(',');
                        if (parts.length < 2) return;
                        const key = parts[0].trim();
                        const value = parts[1].trim();

                        if (!isNaN(value) && value !== '') {
                            state[key] = parseFloat(value);
                        } else if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                            state[key] = value.toLowerCase() === 'true';
                        } else {
                            state[key] = value.replace(/^"|"$/g, '');
                        }
                    });

                    state.currentStepIndex = parseInt(state.currentStepIndex) || 0;
                    state.dsNumber = state.dsNumber || '[X]';
                    state.estimatedReturnDate = state.estimatedReturnDate || "--/--/--";
                    state.quoteText = state.quoteText || "Proverbe Shadok : quand on ne sait pas o√π l'on va, il faut y aller, et le plus vite possible !";
                    state.reportUrl = state.reportUrl || null;

                    return state;

                } catch (error) {
                    console.error("√âchec du chargement de l'√©tat (Onglet STATUT).", error);
                    const errorMessage = error.message.includes("Erreur de configuration") ? error.message : `√âchec de la connexion aux donn√©es. Cause : ${error.message}`;

                    return {
                        totalCopies: '--',
                        currentStepIndex: 0,
                        copiesCorrig√©es: '--',
                        currentAverage: '--',
                        dsNumber: '[X]',
                        currentMood: "D√©sesp√©r√©",
                        hasRemarks: true,
                        estimatedReturnDate: "--/--/--",
                        quoteText: "Erreur de chargement...",
                        remarksText: errorMessage,
                        reportUrl: null,
                        errorState: true
                    };
                }
            }

            async function fetchRemarksList() {
                try {
                    if (SHEET_ID === DEFAULT_SHEET_ID) {
                        return [{ title: "Non configur√©", content: "L'ID de la Feuille est manquant.", isImportant: true }];
                    }

                    const cacheBuster = `&v=${new Date().getTime()}`;
                    const url = REMARKS_SHEET_URL + cacheBuster;
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}. V√©rifiez le GID et l'√©tat de publication de l'onglet REMARQUES.`);
                    }

                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');

                    // Skip header row if present
                    const dataLines = lines.length > 0 && lines[0].toLowerCase().includes('titre') ? lines.slice(1) : lines;

                    const remarksList = dataLines
                        .filter(line => line.trim().length > 0)
                        .map(line => {
                            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                            if (parts.length >= 2) {
                                const title = parts[0].trim().replace(/^"|"$/g, '');
                                const content = parts[1].trim().replace(/^"|"$/g, '');
                                const priority = parts[2] ? parts[2].trim().toUpperCase().replace(/^"|"$/g, '') : 'NORMAL';

                                return {
                                    title: title,
                                    content: content,
                                    isImportant: priority.includes('IMPORTANT')
                                };
                            }
                            return null;
                        }).filter(remark => remark !== null);

                    return remarksList;

                } catch (error) {
                    console.error("√âchec du chargement des remarques (Onglet REMARQUES).", error);
                    return [{ title: "Erreur de chargement", content: `Impossible de lire la liste des remarques. (${error.message})`, isImportant: true }];
                }
            }

            function downloadReport(reportUrl) {
                if (reportUrl) {
                    try {
                        // Ouvre le lien dans un nouvel onglet, ce qui fonctionne pour les PDFs/Pages web
                        window.open(reportUrl, '_blank');
                    } catch (e) {
                        console.error("Erreur lors de l'ouverture du lien :", e);
                        showReportError("Le navigateur a bloqu√© le lien ou celui-ci m√®ne √† un t√©l√©chargement inattendu. Veuillez v√©rifier l'URL fournie.");
                    }
                } else {
                    showReportError("Le rapport final est pr√™t, mais l'URL du rapport (<code>reportUrl</code>) est manquante ou vide.");
                }
            }

            function showReportError(message) {
                const remarksArea = document.getElementById('remarks-area');
                remarksArea.classList.remove('hidden');
                remarksArea.classList.add('error');
                document.getElementById('remarks-button').classList.add('hidden'); 
                remarksArea.innerHTML = `
                    <ul class="remarks-list">
                        <li class="important"> <strong>Avertissement :</strong> ${message} </li>
                    </ul>
                `;
            }

            // =================================================================
            // 4. FONCTION DE MISE √Ä JOUR DE L'INTERFACE
            // =================================================================

            function updateCorrectionDisplay(state, steps, moods, remarksList) {
                // 1. Mise √† jour des Indicateurs Chiffr√©s et Titre
                document.getElementById('ds-number').textContent = state.dsNumber;
                const averageDisplay = state.currentAverage !== '--' && state.currentAverage !== 0 ? state.currentAverage.toFixed(1) : '--';
                document.getElementById('current-average').textContent = averageDisplay;
                document.getElementById('corrected-count').textContent = state.copiesCorrig√©es;
                document.getElementById('total-count').textContent = `/${state.totalCopies || '--'}`;
                document.getElementById('estimated-return-date').textContent = state.estimatedReturnDate;
                document.getElementById('quote-display').textContent = state.quoteText;


                // 2. Mise √† jour de l'Humeur
                const moodData = moods[state.currentMood] || moods["D√©sesp√©r√©"];
                const moodBox = document.getElementById('mood-box');
                const moodIcon = document.getElementById('current-mood-icon');
                const moodText = document.getElementById('current-mood-text');
                const currentMoodName = state.errorState ? 'Erreur Config' : (state.currentMood || "Chargement...");

                moodIcon.textContent = state.errorState ? '‚ùå' : moodData.icon;
                moodText.textContent = currentMoodName;

                const hue = state.errorState ? 0 : moodData.hue;
                moodBox.style.backgroundColor = `hsl(${hue}, 80%, 40%)`;

                // 3. G√©n√©ration et Mise √† jour de la Frise Chronologique
                const timelineStepsContainer = document.getElementById('timeline-steps');
                timelineStepsContainer.innerHTML = '';
                const maxStep = steps.length - 1;

                steps.forEach((step, index) => {
                    if (state.errorState && index > 0) return;

                    const isCompleted = index < state.currentStepIndex;
                    const isActive = index === state.currentStepIndex;

                    const stepDiv = document.createElement('div');
                    let classes = 'timeline-item';
                    if (isCompleted) classes += ' completed';
                    if (isActive) classes += ' active';
                    stepDiv.className = classes;
                    stepDiv.innerHTML = `
                        <div class="step-icon">${step.icon}</div>
                        <p class="step-title">${step.title}</p>
                    `;
                    timelineStepsContainer.appendChild(stepDiv);

                    // Ajout de la fl√®che entre les √©tapes
                    if (index < maxStep && !state.errorState) {
                        const arrowDiv = document.createElement('div');
                        let arrowClasses = 'step-arrow';
                        if (isCompleted) {
                            arrowClasses += ' completed';
                        }
                        arrowDiv.className = arrowClasses;
                        arrowDiv.textContent = '‚ñ∂';
                        timelineStepsContainer.appendChild(arrowDiv);
                    }
                });


                // 4. Gestion du Bouton de Rapport
                const reportButton = document.getElementById('report-button');
                const isFinished = state.currentStepIndex === steps.length - 1 && !state.errorState;
                const isLinkProvided = !!state.reportUrl;
                const isReadyToDownload = isFinished && isLinkProvided;

                if (isReadyToDownload) {
                    reportButton.removeAttribute('disabled');
                    reportButton.onclick = () => downloadReport(state.reportUrl);
                    reportButton.textContent = "T√©l√©charger le rapport";
                } else {
                    reportButton.setAttribute('disabled', 'true');
                    reportButton.onclick = null;
                    if (isFinished && !isLinkProvided) {
                        reportButton.textContent = "Lien du rapport manquant !";
                    } else {
                        reportButton.textContent = "T√©l√©charger le rapport";
                    }
                }


                // 5. Gestion des Remarques (avec priorit√© et fond)
                const remarksButton = document.getElementById('remarks-button');
                const remarksArea = document.getElementById('remarks-area');
                remarksArea.classList.toggle('error', state.errorState);

                const hasImportantRemarks = remarksList.some(r => r.isImportant);
                remarksArea.classList.toggle('important-bg', hasImportantRemarks && !state.errorState);

                let listHTML = '';

                if (state.errorState) {
                    listHTML = `
                        <ul class="remarks-list">
                            <li class="important"><strong>Erreur fatale de connexion :</strong> ${state.remarksText}</li>
                        </ul>
                    `;
                    remarksArea.classList.remove('hidden');
                    remarksButton.classList.add('hidden');

                } else if (remarksList.length > 0) {
                    listHTML = '<ul class="remarks-list">';
                    remarksList.forEach(remark => {
                        const liClass = remark.isImportant ? 'important' : '';
                        listHTML += `
                            <li class="${liClass}"><strong>${remark.title}</strong> : ${remark.content}</li>
                        `;
                    });
                    listHTML += '</ul>';

                    remarksButton.classList.remove('hidden');
                    remarksArea.classList.add('hidden');
                } else {
                    remarksButton.classList.add('hidden');
                    remarksArea.classList.add('hidden');
                }

                remarksArea.innerHTML = listHTML;

                // Logique du bouton Afficher/Masquer
                remarksButton.onclick = () => {
                    const isHidden = remarksArea.classList.toggle('hidden');
                    remarksButton.innerHTML = isHidden ? 'üì¢ Afficher les remarques sur le DS' : '‚ùå Masquer les remarques sur le DS';
                };
            }


            // =================================================================
            // 5. LANCEMENT DE L'APPLICATION
            // =================================================================
            
            function initializeDisplay() {
                const moodBox = document.getElementById('mood-box');
                const moodIcon = document.getElementById('current-mood-icon');
                const moodText = document.getElementById('current-mood-text');
                const moodData = MOODS[DEFAULT_LOADING_STATE.currentMood];

                // Affichage de l'√©tat de chargement initial
                moodBox.style.backgroundColor = `hsl(${moodData.hue}, 80%, 40%)`;
                moodIcon.textContent = moodData.icon;
                moodText.textContent = "Chargement...";
            }


            document.addEventListener('DOMContentLoaded', async () => {
                initializeDisplay();

                if (SHEET_ID === DEFAULT_SHEET_ID) {
                    const errorState = {
                        errorState: true,
                        remarksText: "Erreur de configuration: Veuillez remplacer l'ID de la feuille Google (const SHEET_ID) dans le code JavaScript.",
                        dsNumber: '[X]',
                        currentAverage: '--',
                        copiesCorrig√©es: '--',
                        totalCopies: '--',
                        estimatedReturnDate: "--/--/--",
                        currentStepIndex: 0,
                        quoteText: "Erreur de chargement...",
                        reportUrl: null
                    };
                    updateCorrectionDisplay(errorState, CORRECTION_STEPS, MOODS, []);
                    return;
                }

                const currentState = await fetchCurrentState();
                let remarksList = [];

                if (!currentState.errorState && currentState.hasRemarks) {
                    remarksList = await fetchRemarksList();
                }

                updateCorrectionDisplay(currentState, CORRECTION_STEPS, MOODS, remarksList);
            });
        </script>
    </div>
</div>
